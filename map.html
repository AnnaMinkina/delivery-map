<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–í—ã–±–æ—Ä –∞–¥—Ä–µ—Å–∞</title>
  <link rel="stylesheet" href="style_selection.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://api-maps.yandex.ru/2.1/?apikey=f95f6174-a16f-4470-8845-2f1567950a09&lang=ru_RU"></script>
  <style>
    html, body, #map {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #confirm {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #2ea5ff;
      color: #fff;
      border: none;
      padding: 12px 20px;
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <button id="confirm">üìç –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∞–¥—Ä–µ—Å–æ–º</button>

  <script>
    let map, placemark, coords;

    function init() {
      // –¶–µ–Ω—Ç—Ä –∫–∞—Ä—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ú–æ—Å–∫–≤–∞)
      map = new ymaps.Map("map", {
        center: [55.751244, 37.618423],
        zoom: 10,
        controls: ['zoomControl', 'geolocationControl', 'searchControl']
      });

      // –ü—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–∞—Ä—Ç—É —Å—Ç–∞–≤–∏–º –º–∞—Ä–∫–µ—Ä
      map.events.add('click', function (e) {
        coords = e.get('coords');

        if (placemark) {
          placemark.geometry.setCoordinates(coords);
        } else {
          placemark = new ymaps.Placemark(coords, {}, { draggable: true });
          map.geoObjects.add(placemark);

          // –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø—Ä–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–∏ –º–∞—Ä–∫–µ—Ä–∞
          placemark.events.add('dragend', function () {
            coords = placemark.geometry.getCoordinates();
          });
        }
      });
    }

    ymaps.ready(init);

    // –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è"
    document.getElementById("confirm").addEventListener("click", async () => {
      if (!coords) {
        alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ—á–∫—É –Ω–∞ –∫–∞—Ä—Ç–µ!");
        return;
      }

      try {
        // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
        const res = await ymaps.geocode(coords);
        const firstGeoObject = res.geoObjects.get(0);
        const address = firstGeoObject ? firstGeoObject.getAddressLine() : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–¥—Ä–µ—Å";

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Telegram
        Telegram.WebApp.sendData(JSON.stringify({
          address: address,
          lat: coords[0],
          lon: coords[1]
        }));
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:", err);
        Telegram.WebApp.sendData(JSON.stringify({
          address: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞–¥—Ä–µ—Å–∞",
          lat: coords[0],
          lon: coords[1]
        }));
      }
    });
  </script>
</body>
</html>
